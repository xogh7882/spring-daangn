# 7주차 스터디
###  AWS의 주요 배포 도구 및 서비스
#### : 운영 중인 서비스를 어떻게 새로운 버전으로 안전하게 교체할 것인가에 대한 배포 전략 4가지

<br><hr><br>

### 1. 인플레이스 배포 ( In-place Deployment )
: 기존에 작동하는 프로세스를 중단하고, 새로운 버전의 프로그램을 빌드해서 덮어씌우기

- 서버가 1대 밖에 없는 경우
- 배포 중 잠깐 서비스를 중단해도 상관없는 경우

Ex) 서버 중단 -> 업데이트 -> 서버 재가동

장점
- 단순
- Low 비용 
<br>

단점
- 서비스 중단
- 롤백에도 서비스 중단 시간 발생


<br><hr><br>

### 2. 롤링 배포 ( Rolling Deployment )
: 여러 서버 중에서 하나씩 순차적으로 새 버전으로 교체

- 서버가 여러 대 있는 경우
- 중단 없는 배포가 필요한 경우

Ex) 서버 4대 중에 한 번에 1대씩 업데이트 하기 ( 점진적 전환 )

장점
- 무중단 배포 가능
- 배포 중 오류 발생시, 오류가 발생한 서버만 롤백 가능
<br>

단점
- 오류 발생시 롤백이 어려움 ( 이미 일부 서버는 최신 버전 )
- 새 버전과 구 버전이 동시에 존재 ( 호환성 고려 )

<br><hr><br>

### 3. 블루/그린 배포 ( Blue/Green Deployment )
: Blue ( 현재 버전 ) 와 Green ( 새로운 버전 ) 두 환경을 두고, 그린 환경에서 충분히 테스트를 한 후, 준비가 완료되면 트래픽을  한 번에 블루 환경에서 그린 환경으로 전환

- 장애 발생 시 빠르게 롤백해야 하는 중요한 시스템
- 클라우드 환경에서 인프라 리소스를 여유롭게 사용할 수 있는 경우

Ex) 트래픽 -> Blue (v1)<br>
-> Green (v2) 배포 완료<br>
-> 트래픽 전환 : Green(v2)<br>
-> 오류 발생시 Blue(v1) 으로 Rollback

<br>

장점
- 무중단 배포
- 빠른 롤백 ( 트래픽만 돌리면 바로 롤백 )
- 완전하게 분리된 환경 ( = 안전성 )

단점
- 리소스가 2배 필요 ( Blue + Green )
- 관리 복잡도 증가 ( DB 공유, 동기화 등 )

<br>

### 트래픽? 정확하게 뭐지?
#### 트래픽 ( Traffic )
: 사용자의 요청과 서버의 응답이 오가는 <b> 데이터 흐름</b>

Ex) 사용자가 브라우저에서 http://OOOO.com 에 접속<br>
-> 그 <b>요청</b> 이 서버에 도달<br>
-> 서버가 JSON 등을 응답<br>

=> 이 요청/응답의 흐름 = 트래픽

<br>

#### 블루/그린 에서 "트래픽을 옮긴다" 라는 표현은<br>
-> 사용자의 요청이 가는 대상 서버를 바꾼다!

<br>

#### 그럼 트래픽을 누가 옮겨?
-> 로드 밸런서 ( LB ( Load Balancer) )

- AWS에서는 ALB, NLB, ELB
- Docker Compose 환경에서는 nginx reverse proxy

<br><hr><br>

### 4. 카나리 배포 ( Canary Deployment )
: 전체 사용자 중에서 일부만 새 버전을 먼저 사용하게 해보고, 문제 없으면 점진적으로 확장하는 방식

- 대규모 사용자 대상 서비스
- 배포가 위험 부담이 큰 기능 변경을 포함할 때
- 신중한 실험 배포가 필요할 때

Ex) 전체 사용자 중 5% 에게만 새 버전 노출<br>
-> 문제 없으면 25% 로 증가<br>
-> 50%, 전체로 점진적 확장

장점
- 빠른 실 사용자 피드백 확보
- 문제 발생 시 영향 최소화
- <b>A/B 테스트</b> 사용

단점
- 트래픽 분배 / 모니터링 설정 복잡
- 신/구 버전 동시에 존재 ( 호환성 고려 )

<br>

> <b>A/B 테스트</b><br>
: 두 가지 버전의 콘텐츠를 비교하여 어떤 버전이 사용자에게 효과적인지 판단하는 방법



<br><br>

### 각 상황별로 필요한 배포를 사용하자!
- 개발 단계 : 인플레이스
- 중소 규모 서비스 : 롤링
- 안전성이 최우선인 서비스 : 블루/그린
- 리스크가 큰 기능 : 카나리

<br><hr><br>

### CI / CD
#### CI ( Continuous Integration ) : 지속적 통합
: 개발자들이 코드를 수정할 때마다 자동으로 코드를 합치고 테스트하는 과정

<br>

#### CD ( Continuous Deployment ) : 지속적 배포
: 테스트를 통과한 코드를 자동으로 서비스에 배포하는 과정

<br><hr><br>

### CI/CD가 왜 필요해?
#### 기존 방식
- 코드 작성 -> 수동 테스트 -> 수동 배포
- 테스트 누락 가능성 있음
- 수동 배포 시 실수 가능

<br>

#### CI/CD 방식
- 코드 작성 -> git push -> 자동테스트 & 자동 배포
- 자동화로 테스트 누락 방지
- 자동화로 배포 안정성 향상


<br>

### 조금 더 직관적인 예시..?
#### CI/CD 적용 전
기능 개발 완료 <br>
-> 로컬에서 테스트 <br>
-> EC2 접속 <br>
-> 기존 서비스 중지 <br>
-> git pull & build <br>
-> Error 발생 시 문제 해결 <br>
-> 다시 build <br>
-> 배포 완료 <br>
-> ( 만약 에러 발생 시) <br>
-> 롤백

<br>

#### CI/CD 적용 후
기능 개발 완료 <br>
-> Github에 PR 생성 <br>
-> 자동 테스트 통과 <br>
-> 팀원 코드 리뷰 완료 <br>
-> main 브랜치에 merge <br>
-> 자동으로 배포
-> ( 만약 에러 발생 시) <br>
-> 자동 롤백

<br>

### 또는 여러 명이 작업할 경우
#### CI/CD 적용 전
- 서로 배포 순서 조율 필요
- 수동 테스트로 충돌 발견 늦음
- 배포 실패 시 롤백 복잡함

#### CI/CD 적용 후
- PR만 올리면 자동 테스트
- 충돌 즉시 발견
- 자동 배포 + 문제시 자동 롤백

<br><hr><br>

### CI/CD를 사용하는 이유
- 자동 테스트 강제 실행
- 자동 롤백 기능
- PR만 올리면 자동 테스트
- 코드 푸시만 하면 5분 내 자동 배포

### -> 사람 개입을 최소화 하기 위해 사용!

<br><hr><br>

### 그렇다면 배포 전략 중 하나를 선택해서 CI/CD를 적용한다?

> 주로 사용하는 배포 전략은 롤링 배포
- 블루/그린 배포 : 인프라 리소스 2배 필요
- 인플레이스 배포 : 서비스 중단
- 카나리 배포 : 매우 정교하고 복잡 ( 대기업 / 플랫폼에서 사용 )

<br>

#### 롤링 배포를 하려면 EC2 여러 대 필요
why? 롤링 배포는 서버를 하나씩 순차적으로 업데이트 하는 방법!

> 서버를 여러 대 두는 이유? <br> - 트래픽 분산 <br> - 무중단 배포 <br>

<br><hr>

#### EC2 1대에 컨테이너만 여러 개일 수도 있잖아?
-> 블루/그린 배포 가능!

Ex) EC2 1대 내에서 컨테이너가 여러 개
- myapp-blue ( port 8080 )  <- 현재 버전
- myapp-green ( port 8081 ) <- 새 버전

<br>

#### 하지만 EC2 여러 대가 더 정석적이고 강력한 형태이다
#### why?
- Green 서버와 Blue 서버를 분리
- 트래픽을 통째로 옮기기 때문에 무중단
- 하나의 EC2가 죽어도 나머지가 살아 있기 때문에 고가용성
- 같은 이유로 빠른 롤백 가능

<br><hr><br>

#### EC2 한 대에서 블루/그린 배포 전략으로 CI/CD를 테스트 해보자..!!
